<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <title>Assistant Chat</title>
</head>
<body>
<div id="root"></div>
<script type="module" src="/src/main.tsx"></script>

<script>
    (function(){
        // === CONFIG ===
        const MAX_HEIGHT = '30vh';
        const TOGGLE_BTN_SIZE = 46; // px
        const TRUNCATE_AT_BYTES = 1_048_576; // 1 MB
        const MAX_BYTES_WARNING = TRUNCATE_AT_BYTES;

        // === UI ===
        const container = document.createElement('div');
        container.id = 'tma-debug-container';
        Object.assign(container.style, {
            position: 'fixed',
            right: '12px',
            bottom: '12px',
            zIndex: '999999',
            fontFamily: 'Menlo, Monaco, monospace',
            lineHeight: '1.2',
            pointerEvents: 'none'
        });

        const btn = document.createElement('button');
        btn.textContent = 'DBG';
        Object.assign(btn.style, {
            width: TOGGLE_BTN_SIZE + 'px',
            height: TOGGLE_BTN_SIZE + 'px',
            borderRadius: '8px',
            border: 'none',
            boxShadow: '0 2px 8px rgba(0,0,0,0.35)',
            background: 'rgba(0,0,0,0.65)',
            color: '#bada55',
            cursor: 'pointer',
            pointerEvents: 'auto',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '14px'
        });

        const panel = document.createElement('div');
        Object.assign(panel.style, {
            display: 'none',
            width: 'min(90vw,720px)',
            maxHeight: MAX_HEIGHT,
            overflow: 'auto',
            background: 'rgba(0,0,0,0.85)',
            color: '#e6ffb3',
            padding: '8px',
            borderRadius: '8px',
            boxShadow: '0 6px 24px rgba(0,0,0,0.6)',
            pointerEvents: 'auto',
            whiteSpace: 'pre-wrap',
            fontSize: '12px'
        });

        const header = document.createElement('div');
        Object.assign(header.style, {
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '6px'
        });

        const hdrTitle = document.createElement('div');
        hdrTitle.textContent = 'TMA Debug Console';
        Object.assign(hdrTitle.style, { fontWeight: '600', fontSize: '13px', opacity: '0.9' });

        const hdrControls = document.createElement('div');
        const clearBtn = document.createElement('button');
        clearBtn.textContent = 'Clear';
        clearBtn.style.marginRight = '6px';
        clearBtn.style.cursor = 'pointer';
        const collapseBtn = document.createElement('button');
        collapseBtn.textContent = 'Close';
        collapseBtn.style.cursor = 'pointer';

        const messages = document.createElement('div');
        Object.assign(messages.style, { display: 'flex', flexDirection: 'column', gap: '6px' });

        hdrControls.append(clearBtn, collapseBtn);
        header.append(hdrTitle, hdrControls);
        panel.append(header, messages);
        container.append(btn, panel);
        document.body.appendChild(container);

        // подсветка json
        const style = document.createElement('style');
        style.textContent = `
    .json-key { color: #9cdcfe; }
    .json-string { color: #ce9178; }
    .json-number { color: #b5cea8; }
    .json-boolean { color: #569cd6; }
    .json-null { color: #808080; }
  `;
        document.head.appendChild(style);

        let expanded = false;
        const ts = () => new Date().toISOString();
        const humanBytes = n => n < 1024 ? n+' B' : n < 1024*1024 ? (n/1024).toFixed(1)+' KB' : (n/1024/1024).toFixed(2)+' MB';

        const showPanel = () => { expanded = true; panel.style.display='block'; btn.style.display='none'; container.style.pointerEvents='auto'; };
        const hidePanel = () => { expanded = false; panel.style.display='none'; btn.style.display='flex'; container.style.pointerEvents='none'; };

        btn.onclick = e => { e.stopPropagation(); showPanel(); };
        collapseBtn.onclick = e => { e.stopPropagation(); hidePanel(); };
        clearBtn.onclick = e => { e.stopPropagation(); messages.innerHTML=''; };

        // JSON syntax highlight
        function syntaxHighlight(json) {
            if (typeof json != 'string') json = JSON.stringify(json, null, 2);
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(
                /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                match => {
                    let cls = 'number';
                    if (/^"/.test(match)) cls = /:$/.test(match) ? 'key' : 'string';
                    else if (/true|false/.test(match)) cls = 'boolean';
                    else if (/null/.test(match)) cls = 'null';
                    return `<span class="json-${cls}">${match}</span>`;
                }
            );
        }

        function appendEntry(kind, ...args){
            const wrap = document.createElement('div');
            Object.assign(wrap.style,{
                padding:'6px',borderRadius:'6px',
                background:kind==='err'?'rgba(128,0,0,0.6)':'rgba(255,255,255,0.02)',
                borderLeft:kind==='err'?'4px solid rgba(255,100,100,0.9)':'4px solid rgba(120,200,120,0.6)',
                fontSize:'12px',color:'#e6ffb3',overflowWrap:'anywhere'
            });
            const head = document.createElement('div');
            Object.assign(head.style,{opacity:'0.8',fontSize:'11px',marginBottom:'4px'});
            head.textContent = `${ts()} — ${kind.toUpperCase()}`;
            const body = document.createElement('pre');
            Object.assign(body.style,{margin:'0',whiteSpace:'pre-wrap',fontFamily:'inherit',fontSize:'12px'});
            const parts = args.map(a=>{
                try{
                    if(typeof a==='string' && /^\s*[{[]/.test(a)){
                        try{return syntaxHighlight(JSON.parse(a));}catch{return a;}
                    }
                    if(typeof a==='object') return syntaxHighlight(a);
                    return a;
                }catch(e){return String(a);}
            });
            body.innerHTML = parts.join(' ');
            wrap.append(head,body);
            messages.appendChild(wrap);
            panel.scrollTop = panel.scrollHeight;
        }

        const truncateByBytes = (str,max)=>{
            const enc=new TextEncoder(),bytes=enc.encode(str);
            if(bytes.length<=max)return{text:str,size:bytes.length,truncated:false};
            let lo=0,hi=str.length;
            while(lo<hi){
                const mid=Math.ceil((lo+hi)/2);
                const len=enc.encode(str.slice(0,mid)).length;
                if(len<=max)lo=mid;else hi=mid-1;
            }
            let prefix=str.slice(0,lo);
            while(enc.encode(prefix).length>max)prefix=prefix.slice(0,-1);
            return{text:prefix,size:bytes.length,truncated:true};
        };

        window.TMA_DBG={log:(...a)=>appendEntry('log',...a),err:(...a)=>appendEntry('err',...a),
            show:showPanel,hide:hidePanel,clear:()=>messages.innerHTML=''};

        appendEntry('log','location.search',location.search||'(none)');
        if(window.Telegram&&Telegram.WebApp){
            try{
                appendEntry('log','telegram.initData',Telegram.WebApp.initData);
                appendEntry('log','telegram.isExpanded',Telegram.WebApp.isExpanded);
            }catch(e){appendEntry('err','error reading Telegram.WebApp',String(e));}
        }else appendEntry('log','Telegram.WebApp not present (running in browser?)');

        // === fetch patch ===
        (function(){
            if(!window.fetch)return;
            const orig=window.fetch.bind(window);
            window.fetch=async function(resource,init){
                const method=(init&&init.method)||'GET';
                appendEntry('log',`[fetch -> ${method}]`,String(resource));
                const start=Date.now();
                try{
                    const res=await orig(resource,init);
                    const elapsed=Date.now()-start;
                    let full='',size=0,isBin=false;
                    try{full=await res.clone().text();size=new TextEncoder().encode(full).length;}
                    catch{try{const b=await res.clone().blob();size=b.size||0;isBin=true;}catch(e){full=`<cannot-read-body: ${e}>`;}}
                    if(isBin){
                        appendEntry('log',`[fetch res ${res.status} ${elapsed}ms] ${resource} — binary ${humanBytes(size)}`);
                    }else{
                        if(size>MAX_BYTES_WARNING) appendEntry('log',`[fetch res ${res.status} ${elapsed}ms] ${resource} — ${humanBytes(size)} (truncated to ${humanBytes(TRUNCATE_AT_BYTES)})`);
                        const {text,truncated}=truncateByBytes(full,TRUNCATE_AT_BYTES);
                        if(truncated){
                            appendEntry('log',`[fetch res ${res.status} ${elapsed}ms] ${resource} — body (TRUNCATED):`,text+`\n\n[...truncated ${humanBytes(size-TRUNCATE_AT_BYTES)}]`);
                        }else appendEntry('log',`[fetch res ${res.status} ${elapsed}ms] ${resource}`,text);
                    }
                    return res;
                }catch(e){appendEntry('err',`[fetch ERROR]`,String(resource),e.toString());throw e;}
            };
        })();

        // === XHR patch ===
        (function(){
            const XHR=window.XMLHttpRequest;if(!XHR)return;
            function Wrapped(){const x=new XHR();let u='',m='';const o=x.open;x.open=function(mm,uu,...r){m=mm;u=uu;return o.call(this,mm,uu,...r);};
                const s=x.send;x.send=function(b){this.addEventListener('loadend',()=>{
                    try{
                        const t=this.responseText||'',bytes=new TextEncoder().encode(t).length;
                        if(bytes>MAX_BYTES_WARNING)appendEntry('log',`[XHR ${this.status}] ${m} ${u} — ${humanBytes(bytes)} (truncated to ${humanBytes(TRUNCATE_AT_BYTES)})`);
                        const {text,truncated}=truncateByBytes(t,TRUNCATE_AT_BYTES);
                        if(truncated)appendEntry('log',`[XHR ${this.status}] ${m} ${u} — body (TRUNCATED):`,text+`\n\n[...truncated ${humanBytes(bytes-TRUNCATE_AT_BYTES)}]`);
                        else appendEntry('log',`[XHR ${this.status}] ${m} ${u}`,t||'<empty>');
                    }catch(e){appendEntry('err',`[XHR read ERROR]`,m,u,String(e));}
                });return s.call(this,b);};return x;}
            Wrapped.prototype=XHR.prototype;window.XMLHttpRequest=Wrapped;
        })();

        hidePanel();
        window.dbg=(...a)=>appendEntry('log',...a);
    })();
</script>

</body>
</html>
